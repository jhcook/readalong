# runbook

You are an implementation agent for this repository following .agent/rules/ governance.

## PURPOSE

Convert a Story (requirements) into an Implementation Runbook (blueprint) that ensures:
1.  Compliance with all .agent/{rules,adrs,compliance}/
2.  No regression of existing features
3.  Adherence to the Story's requirements
4.  Safe, step-by-step execution
5. Component Specification & Interface
API Definition: Define clear entry and exit points (REST, gRPC, or GraphQL). Use OpenAPI/Swagger specs to define request/response schemas.

Data Models: Specify the core entities and DTOs (Data Transfer Objects) the component will handle.

Dependency Injection: List external services, databases, or third-party APIs the component must interact with.

State Management: Explicitly state if the component is stateless or if it must manage internal state/persistence.

6. Implementation Guardrails
Tech Stack Standards: Mandate the language version (e.g., Python 3.12+), framework (FastAPI/Next.js), and linting/formatting rules (Ruff, Prettier).

Error Handling Strategy: Define standard error codes (e.g., using RFC 7807 Problem Details) and how the component should fail gracefully.

Security Requirements: Specify authentication (OAuth2/OIDC) and authorization (RBAC/ABAC) requirements, including secrets management via Vault or Google Secret Manager.

7. Logic & Design Patterns
Architectural Pattern: Require a specific structure (e.g., Hexagonal Architecture or Clean Architecture) to separate business logic from infrastructure.

Concurrency & Scaling: Outline how the component handles asynchronous tasks (e.g., Celery, BullMQ) and its expected behavior under high load.

Idempotency: For components handling writes or payments, define how to handle retries without duplicating actions.

8. Quality & Observability
Testing Requirements: Set a minimum threshold for unit test coverage (e.g., 80%) and define mandatory integration test scenarios.

Logging Schema: Enforce structured logging (JSON) with specific fields like correlation_id, user_id, and environment.

Metrics & Health Checks: Define the standard endpoints (e.g., /healthz, /metrics) for Prometheus/Grafana monitoring.

9. Deployment & Lifecycle
CI/CD Pipeline: Detail the required GitHub Actions or GitLab CI steps for building, scanning (Snyk/Trivy), and deploying the component.

Infrastructure as Code (IaC): Provide a template (Terraform or Pulumi) for the cloud resources the component requires.

Documentation: Require updated or new automated documentation for all internal logic.

## GENERATION PROCESS

The Runbook is generated by an **AI Governance Panel** consisting of:
- **@Architect**: Ensures the design matches the Story and system architecture.
- **@Security**: Validates that all security protocols are followed.
- **@QA**: Defines the testing strategy and key user flows.
- **@Docs**: Ensures documentation updates are planned.
- **@Compliance**: Checks against regulatory and project rules.
- **@Observability**: Ensures logging and monitoring are sufficient.

This panel collaborates to produce a Runbook that is:
1.  **Detailed**: Sufficient for a qualified engineer to implement without ambiguity.
2.  **Compliant**: Adheres to all `.agent/rules/` and `.agent/compliance/`.
3.  **Safe**: minimized risk of regressions.

## SYNTAX

```bash
agent new-runbook <STORY-ID>
```

## OUTPUT

A markdown file at `.agent/cache/runbooks/<SCOPE>/<STORY-ID>-runbook.md` with the following structure:

```markdown
# <STORY-ID>: <Title>

Status: PROPOSED  <-- MUST be manually changed to ACCEPTED by the team

## Goal Description
<Summary of what changes>

## Compliance Checklist
- [ ] @Security approved?
- [ ] @Architect approved?
- [ ] @QA approved?
- [ ] @Docs approved?
- [ ] @Compliance approved?
- [ ] @Observability approved?

## Proposed Changes
### [Component]
#### [MODIFY] [file](path)
- Change description...

## Verification Plan
- How to test...
```

## WORKFLOW

1.  **Read Story**: Validate the story exists in `.agent/cache/stories/`.
2.  **Generate Runbook**: Use AI to analyze the story + rules and generate the runbook.
3.  **Review**: The team reviews the runbook.
4.  **Accept**: The team changes `Status: PROPOSED` to `Status: ACCEPTED`.
5.  **Execute**: The `agent implement` command refers to this runbook.
