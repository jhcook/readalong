# Distributing ReadAlong Extensions

This guide outlines the steps to publish the ReadAlong browser extension to official browser stores.

## 1. Prerequisites

Before submitting to any store, ensure:
- You have built the production assets: `npm run build` in `web/extension`.
- You have generated the distribution packages: `npm run package` in `web/extension`.
- You have the `release/` directory containing `readalong-chrome.zip`, `readalong-firefox.zip`, and `readalong-safari.zip`.
- All automated tests pass: `npm test`.

## 2. Chrome Web Store (Chrome / Edge / Brave)

1.  **Developer Account**: Create a developer account at the [Chrome Web Store Developer Console](https://chrome.google.com/webstore/devconsole). (One-time fee required).
2.  **Add New Item**: Click "New Item".
3.  **Upload**: Upload `readalong-chrome.zip`.
4.  **Metadata**:
    - **Description**: Provide a clear, child-safe description.
    - **Screenshots**: Upload at least one 1280x800 or 640x400 screenshot.
    - **Icon**: Upload a 128x128 icon.
5.  **Privacy**: Describe why the extension needs the requested permissions (e.g., `activeTab` for text extraction).
6.  **Review**: Submit for review.

## 3. Firefox Add-ons (AMO)

1.  **Account**: Sign in to [AMO Developer Hub](https://addons.mozilla.org/developers/).
2.  **Submit**: Click "Submit a New Add-on".
3.  **Upload**: Upload `readalong-firefox.zip`.
4.  **Self-Distribution vs. AMO**: Choose "On this site" for hosting on AMO.
5.  **Version Notes**: Use this template:

```
Firefox compatibility fixes:
- Added data_collection_permissions (required: ["none"]) - extension does not collect any data
- Implemented fallback audio playback for browsers without offscreen API
- Removed sandbox.js (vosk-browser STT) as it exceeded 5MB file limit

Regarding validation warnings:
- "Function constructor is eval": From @opentelemetry tracing library (safe, no user input)
- "Unsafe innerHTML": All HTML is sanitized via DOMPurify before assignment. Used for:
  • Rendering sanitized article content in reading pane
  • Creating temporary DOM elements for text extraction (immediately discarded)
```

6.  **Notes to Reviewer**:

```
This extension does not require account credentials to test. Core functionality:
1. Click extension icon → "Extract Text" to extract content from any webpage
2. Choose a voice source (System/Browser voices work without API keys)
3. Click "Read Aloud" to hear the content

Optional cloud voice integrations (ElevenLabs, Google Cloud, Resemble) require user's own API keys entered in Options.
```

7.  **Review**: Firefox performs automated review followed by manual check.

### Firefox for Android

The extension supports Firefox for Android (v142+) via `gecko_android: {}` in the manifest.

**Known Limitations:**
- **System voices**: SpeechSynthesis API support varies by Android device
- **Cloud voices**: Work via audio fallback (ElevenLabs, Google, Resemble)
- **UI**: Popup displays in mobile view; touch interactions supported

**Testing on Android:**
1. Install Firefox for Android (v142+)
2. Navigate to `about:debugging` on desktop Firefox
3. Use "Connect" to pair with Android device
4. Install extension via remote debugging, or wait for AMO approval

## 4. Microsoft Edge Add-ons

1.  **Account**: Register at the [Microsoft Partner Center](https://partner.microsoft.com/en-us/dashboard/microsoftedge/overview).
2.  **Create New**: Click "Create new extension".
3.  **Upload**: Upload `readalong-chrome.zip` (Edge supports Chrome extensions natively).
4.  **Metadata**: Provide Edge-specific descriptions and assets if desired.

## 5. Safari (macOS, iOS, iPadOS, visionOS)

Safari extensions are bundled within a native app that runs on macOS, iOS, and iPadOS.
1.  **Apple Developer Program**: Requires an active membership.
2.  **Xcode**: Open the Xcode project generated by `xcrun safari-web-extension-converter`.
3.  **App Store Connect**: Create a new app record.
    1.  Log in to [App Store Connect](https://appstoreconnect.apple.com).
    2.  Click **"My Apps"**.
    3.  Click the **"+"** icon (top-left) and select **"New App"**.
    4.  Fill in the details:
        - **Platforms**: Check "macOS" and "iOS". (visionOS is included via "Designed for iPad" or specific selection).
        - **Name**: "ReadAlong" (must be unique on the Store).
        - **Primary Language**: English.
        - **Bundle ID**: Select the one matching your Xcode project (e.g., `com.yourName.readalong`).
          > **Tip:** If registering this App ID manually in the Developer Portal, you do **not** need to select any "Capabilities" (like iCloud or App Groups). Leave them unchecked.
        - **SKU**: A unique internal ID (e.g., `READALONG_MAC_001`).
        - **User Access**: Full Access.
    5.  Click **"Create"**.
4.  **Archive & Upload**: In Xcode, select "Product" > "Archive", then "Distribute App" to upload to App Store Connect.

### Generating the Xcode Project

To generate the Safari extension wrapper:

```bash
cd web/extension
xcrun safari-web-extension-converter dist
open ReadAlong/ReadAlong.xcodeproj
```

### Troubleshooting: `xcrun: error: unable to find utility`

If you encounter `xcrun: error: unable to find utility "safari-web-extension-converter"`, it means your active developer directory is pointing to the Command Line Tools instead of the full Xcode application.

**Fix:**
1. Ensure you have the full **Xcode** application installed from the App Store.
2. Switch the active developer directory:

```bash
sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
```

3. Verify the path: `xcode-select -p` should return `/Applications/Xcode.app/Contents/Developer`.

### Testing on iOS, iPadOS & visionOS

1.  **Simulator**:
    - Select the **"ReadAlong (iOS)"** release scheme in Xcode.
    - Choose a Simulator (e.g., iPhone 15 Pro, Apple Vision Pro) from the device list.
    - Click "Run" (Play button).
    - On the simulator: Open Safari > tap 'aA' (or eye icon) > Manage Extensions > Enable ReadAlong.

2.  **Physical Device**:
    - Connect your iPhone/iPad to your Mac.
    - Select your device in Xcode's device list.
    - You must sign the app with a valid Apple Developer Team profile in the "Signing & Capabilities" tab for the `ReadAlong (iOS)` target.
    - Click "Run".
    - On device: Settings > Safari > Extensions > ReadAlong > Toggle "Allow Extension".

### Safari Known Limitations

The converter may output warnings about unsupported manifest keys (`sandbox`, `offscreen`, `open_in_tab`).

- **Audio Playback**: The extension automatically falls back to standard HTML5 audio when the `offscreen` API is unavailable, ensuring playback continues to work in Safari.
- **Offline STT (Vosk)**: Safari does not support the `sandbox` manifest key used for the Vosk speech recognition engine. Offline voice commands/STT may not function.
- **UI**: Some UI behaviors (like opening options in a tab) may differ slightly.

**iOS/iPadOS Specifics:**
- **UI Layout**: The extension popup automatically adapts to the smaller specific screen size.
- **Background Persistence**: iOS is more aggressive about suspending background pages. Long-running tasks should be avoided or handled carefully.

**visionOS Specifics:**
- **Compatibility**: The extension works out-of-the-box on visionOS via **iPad App Compatibility**. Users will see the "Designed for iPad" version.
- **Native Experience**: For a fully native look (glassmorphism), a specific visionOS target can be added in Xcode, but the iPad version is fully functional.

---
> [!IMPORTANT]
> Ensure the `manifest.json` version matches the store requirements (MV3 for most, Safari handles it via the converter).
